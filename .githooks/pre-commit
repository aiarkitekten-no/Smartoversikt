#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")"/../.. && pwd)"

# Kjør eksisterende widget-sjekk
php "$ROOT_DIR/scripts/check-widgets.php"

# NYTT: Widget Lock System - Per-Widget Protection
WIDGET_DIR="$ROOT_DIR/resources/views/widgets"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}🔍 Checking widget locks...${NC}"

# Sjekk om låste widgets er endret
CHANGED_WIDGETS=$(git diff --cached --name-only | grep "^resources/views/widgets/.*\.blade\.php$" || true)

if [ -n "$CHANGED_WIDGETS" ]; then
    echo -e "${YELLOW}📝 Widget changes detected:${NC}"
    echo "$CHANGED_WIDGETS" | sed 's/^/   /'
    echo ""
    
    BLOCKED=0
    
    while IFS= read -r widget_file; do
        if [ -z "$widget_file" ]; then
            continue
        fi
        
        widget_name=$(basename "$widget_file" .blade.php)
        lock_file="${WIDGET_DIR}/.${widget_name}.lock"
        
        # Sjekk om widget er låst (lock-fil eksisterer)
        if [ -f "$lock_file" ]; then
            echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
            echo -e "${RED}🚨 BLOCKED: Attempting to modify LOCKED widget!${NC}"
            echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
            echo ""
            echo "   Widget: $widget_name"
            echo "   File: $widget_file"
            echo ""
            echo "   Lock file: $lock_file"
            echo ""
            cat "$lock_file" | sed 's/^/   /'
            echo ""
            echo -e "${YELLOW}   To unlock this widget, run:${NC}"
            echo -e "   ${GREEN}./scripts/unlock-widget.sh $widget_name${NC}"
            echo ""
            BLOCKED=1
        fi
    done <<< "$CHANGED_WIDGETS"
    
    if [ $BLOCKED -eq 1 ]; then
        echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${RED}❌ Commit blocked due to locked widget modifications${NC}"
        echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✅ All modified widgets are unlocked - changes allowed${NC}"
fi

echo -e "${GREEN}✅ Widget lock checks passed${NC}"
